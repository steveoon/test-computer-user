name: Claude Code Review

on:
  pull_request:
    types: [opened, synchronize, reopened]
    branches: [main, develop]
    paths:
      - '**.ts'
      - '**.tsx'
      - '**.js'
      - '**.jsx'
      - 'package.json'
      - 'tsconfig.json'
      - '.github/workflows/code-review.yml'
      - '.github/scripts/**'

# å–æ¶ˆä¹‹å‰è¿è¡Œçš„å·¥ä½œæµ
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  claude-review:
    # ä½¿ç”¨è‡ªæ‰˜ç®¡ runner æˆ– GitHub æ‰˜ç®¡çš„ runner
    runs-on: ${{ vars.USE_SELF_HOSTED_RUNNER == 'true' && 'self-hosted' || 'ubuntu-latest' }}
    permissions:
      contents: read
      pull-requests: write
      checks: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ç”Ÿæˆå‡†ç¡®çš„diff
        
    - name: Setup dependencies
      run: |
        # å®‰è£…å¿…è¦çš„å·¥å…·
        sudo apt-get update
        sudo apt-get install -y jq
        
        # éªŒè¯å·¥å…·å®‰è£…
        echo "âœ… jq version: $(jq --version)"
        
    - name: Setup Claude Code CLI
      run: |
        echo "ğŸ”§ Setting up Claude Code CLI..."
        
        # ====== Claude CLI è®¤è¯é…ç½®é€‰é¡¹ ======
        # 
        # é€‰é¡¹ 1: ä½¿ç”¨è‡ªæ‰˜ç®¡ Runnerï¼ˆæ¨èç”¨äºç”Ÿäº§ç¯å¢ƒï¼‰
        # - åœ¨è‡ªå·±çš„æœåŠ¡å™¨ä¸Šé…ç½® GitHub Actions Runner
        # - é¢„å…ˆåœ¨ runner ä¸Šæ‰§è¡Œ `claude login` å®Œæˆè®¤è¯
        # - Runner å°†å¯ä»¥ä½¿ç”¨å·²è®¤è¯çš„ Claude CLI
        #
        # é€‰é¡¹ 2: ä½¿ç”¨ API è®¤è¯ï¼ˆå¦‚æœå¯ç”¨ï¼‰
        # - åœ¨ GitHub Settings > Secrets ä¸­æ·»åŠ è®¤è¯å‡­æ®
        # - ä¾‹å¦‚: CLAUDE_API_TOKEN æˆ–å…¶ä»–è®¤è¯æ–¹å¼
        # if [[ -n "${{ secrets.CLAUDE_API_TOKEN || '' }}" ]]; then
        #   export CLAUDE_API_TOKEN="${{ secrets.CLAUDE_API_TOKEN }}"
        # fi
        #
        # é€‰é¡¹ 3: ä½¿ç”¨æ¨¡æ‹Ÿæ¨¡å¼ï¼ˆé»˜è®¤ï¼Œç”¨äºæµ‹è¯•ï¼‰
        # - ä¸éœ€è¦çœŸå®çš„ Claude CLI
        # - è¿”å›æ¨¡æ‹Ÿçš„å®¡æŸ¥ç»“æœ
        # =====================================
        
        # æ£€æŸ¥æ˜¯å¦æœ‰å¯ç”¨çš„è®¤è¯é…ç½®
        # æ³¨æ„: IDE å¯èƒ½ä¼šè­¦å‘Šè¿™äº› secrets æ— æ•ˆï¼Œè¿™æ˜¯æ­£å¸¸çš„
        # è¿™äº› secrets éœ€è¦åœ¨ GitHub ä»“åº“çš„ Settings > Secrets ä¸­é…ç½®
        # ä½¿ç”¨ || '' æä¾›é»˜è®¤å€¼ä»¥é¿å…è¿è¡Œæ—¶é”™è¯¯
        if [[ -n "${{ secrets.CLAUDE_API_TOKEN || '' }}" ]]; then
          echo "ğŸ”‘ Using API token authentication"
          export CLAUDE_API_TOKEN="${{ secrets.CLAUDE_API_TOKEN }}"
        elif [[ -n "${{ secrets.CLAUDE_CONFIG || '' }}" ]]; then
          echo "ğŸ”‘ Using custom configuration"
          mkdir -p ~/.claude
          echo "${{ secrets.CLAUDE_CONFIG }}" | base64 -d > ~/.claude/config.json
        fi
        
        # å°è¯•å®‰è£… Claude CLIï¼ˆå¦‚æœæä¾›äº†å®‰è£…URLï¼‰
        # vars.CLAUDE_INSTALL_URL æ˜¯ä»“åº“å˜é‡ï¼Œåœ¨ Settings > Variables ä¸­é…ç½®
        if [[ -n "${{ vars.CLAUDE_INSTALL_URL || '' }}" ]]; then
          echo "ğŸ“¥ Installing Claude CLI from: ${{ vars.CLAUDE_INSTALL_URL }}"
          curl -fsSL "${{ vars.CLAUDE_INSTALL_URL }}" | sh || {
            echo "âš ï¸ Failed to install Claude CLI"
          }
        fi
        
        # éªŒè¯ Claude CLI æ˜¯å¦å¯ç”¨
        if command -v claude >/dev/null 2>&1; then
          echo "âœ… Claude CLI is installed"
          claude --version || echo "Version check failed"
        else
          echo "âš ï¸ Claude CLI not found, using mock mode for testing"
          echo "ğŸ’¡ To use real Claude CLI, please configure one of the authentication options above"
          
          # åˆ›å»ºæ¨¡æ‹Ÿçš„ claude å‘½ä»¤ç”¨äºæ¼”ç¤ºå’Œæµ‹è¯•
          mkdir -p /tmp/bin
          cat > /tmp/bin/claude << 'MOCK_EOF'
        #!/bin/bash
        # Mock Claude CLI for testing purposes
        if [[ "$1" == "-p" ]] && [[ "$3" == "--json" ]]; then
          cat << 'JSON_EOF'
        {
          "overall_score": 9,
          "security_issues": [],
          "performance_concerns": [],
          "quality_issues": [],
          "typescript_issues": [],
          "react_issues": [],
          "issues": [],
          "detailed_analysis": "This is a mock review for testing purposes. The code appears to follow best practices.",
          "recommendations": [
            "Continue following TypeScript strict mode",
            "Consider adding more unit tests for new components",
            "Keep monitoring bundle size as the project grows"
          ],
          "approved": true,
          "stats": {
            "files_reviewed": 1,
            "lines_changed": 50,
            "test_coverage_impact": "positive"
          }
        }
        JSON_EOF
        else
          echo "Claude Code CLI (Mock Version)"
          echo "This is a mock implementation for testing GitHub Actions workflow"
        fi
        MOCK_EOF
          chmod +x /tmp/bin/claude
          export PATH="/tmp/bin:$PATH"
          echo "âœ… Mock Claude CLI created for demonstration"
        fi
        
    - name: Get changed files
      id: changed-files
      run: |
        # è·å–PRä¸­å˜æ›´çš„æ–‡ä»¶
        echo "ğŸ” Detecting changed files..."
        git diff --name-only origin/${{ github.base_ref }}..HEAD > changed_files.txt
        
        # æ˜¾ç¤ºå˜æ›´æ–‡ä»¶
        echo "ğŸ“ Changed files:"
        cat changed_files.txt
        
        # è®¾ç½®è¾“å‡º
        echo "files=$(cat changed_files.txt | tr '\n' ' ')" >> $GITHUB_OUTPUT
        echo "count=$(cat changed_files.txt | wc -l)" >> $GITHUB_OUTPUT
        
    - name: Run Claude Review
      id: review
      env:
        GITHUB_BASE_REF: ${{ github.base_ref }}
      run: |
        echo "ğŸ¤– Starting code review for ${{ steps.changed-files.outputs.count }} files..."
        
        # è¿è¡Œå®¡æŸ¥è„šæœ¬
        if bash .github/scripts/claude-review.sh "${{ steps.changed-files.outputs.files }}"; then
          echo "review_status=success" >> $GITHUB_OUTPUT
        else
          echo "review_status=failed" >> $GITHUB_OUTPUT
          echo "âŒ Review script failed"
        fi
        
        # æ£€æŸ¥ç»“æœæ–‡ä»¶
        if [ -f review_result.json ]; then
          echo "âœ… Review result generated"
          # æå–å…³é”®ä¿¡æ¯åˆ°è¾“å‡º
          echo "score=$(jq -r '.overall_score' review_result.json)" >> $GITHUB_OUTPUT
          echo "approved=$(jq -r '.approved' review_result.json)" >> $GITHUB_OUTPUT
          echo "total_issues=$(jq -r '.issues | length' review_result.json)" >> $GITHUB_OUTPUT
        else
          echo "âŒ No review result found"
          echo "score=0" >> $GITHUB_OUTPUT
          echo "approved=false" >> $GITHUB_OUTPUT
          echo "total_issues=0" >> $GITHUB_OUTPUT
        fi
        
    - name: Post Review Comment
      if: always() && steps.review.outputs.review_status != ''
      uses: actions/github-script@v7
      with:
        script: |
          const fs = require('fs');
          
          // è¯»å–å®¡æŸ¥ç»“æœ
          let review;
          try {
            const reviewResult = fs.readFileSync('review_result.json', 'utf8');
            review = JSON.parse(reviewResult);
          } catch (error) {
            console.error('Failed to read review result:', error);
            review = {
              overall_score: 0,
              security_issues: [],
              performance_concerns: [],
              quality_issues: [],
              typescript_issues: [],
              react_issues: [],
              issues: [],
              detailed_analysis: 'Failed to generate review due to an error.',
              recommendations: [],
              approved: false,
              error: true
            };
          }
          
          // æ„å»ºè¯„è®ºå†…å®¹
          let statusEmoji = review.approved ? 'âœ…' : 'âŒ';
          let statusText = review.approved ? 'APPROVED' : 'CHANGES REQUESTED';
          
          // åˆ›å»ºé—®é¢˜åˆ†ç»„
          const issueGroups = [
            { name: 'ğŸ”’ Security Issues', items: review.security_issues || [], emoji: 'ğŸ”´' },
            { name: 'ğŸ“˜ TypeScript Issues', items: review.typescript_issues || [], emoji: 'ğŸŸ ' },
            { name: 'âš›ï¸ React/Next.js Issues', items: review.react_issues || [], emoji: 'ğŸŸ¡' },
            { name: 'âš¡ Performance Concerns', items: review.performance_concerns || [], emoji: 'ğŸŸ¢' },
            { name: 'ğŸ—ï¸ Code Quality Issues', items: review.quality_issues || [], emoji: 'ğŸ”µ' }
          ];
          
          // ç”Ÿæˆé—®é¢˜è¯¦æƒ…
          let issuesDetail = '';
          for (const group of issueGroups) {
            if (group.items.length > 0) {
              issuesDetail += `\n### ${group.name} (${group.items.length})\n\n`;
              for (const issue of group.items) {
                issuesDetail += `${group.emoji} **[${issue.severity.toUpperCase()}]** ${issue.description}\n`;
                issuesDetail += `   ğŸ“ \`${issue.file}:${issue.line}\`\n`;
                issuesDetail += `   ğŸ’¡ ${issue.suggestion}\n`;
                if (issue.code_example) {
                  issuesDetail += `   \`\`\`typescript\n   ${issue.code_example}\n   \`\`\`\n`;
                }
                issuesDetail += '\n';
              }
            }
          }
          
          // ç”Ÿæˆç»Ÿè®¡ä¿¡æ¯
          const stats = review.stats || {};
          let statsInfo = '';
          if (stats.files_reviewed) {
            statsInfo = `
          ### ğŸ“Š Review Statistics
          - **Files Reviewed:** ${stats.files_reviewed}
          - **Lines Changed:** ${stats.lines_changed || 'N/A'}
          - **Test Coverage Impact:** ${stats.test_coverage_impact || 'unknown'}
          `;
          }
          
          const comment = `## ğŸ¤– Claude Code Review
          
          ### ${statusEmoji} Review Status: ${statusText}
          
          **Overall Score:** ${review.overall_score}/10 ${review.overall_score >= 8 ? 'âœ¨' : 'âš ï¸'}
          
          <details>
          <summary><b>ğŸ“ˆ Issues Summary</b> (Total: ${review.issues ? review.issues.length : 0})</summary>
          
          - ğŸ”’ Security Issues: ${review.security_issues ? review.security_issues.length : 0}
          - ğŸ“˜ TypeScript Issues: ${review.typescript_issues ? review.typescript_issues.length : 0}
          - âš›ï¸ React/Next.js Issues: ${review.react_issues ? review.react_issues.length : 0}
          - âš¡ Performance Concerns: ${review.performance_concerns ? review.performance_concerns.length : 0}
          - ğŸ—ï¸ Code Quality Issues: ${review.quality_issues ? review.quality_issues.length : 0}
          
          </details>
          
          ### ğŸ” Detailed Analysis
          ${review.detailed_analysis || 'No detailed analysis available.'}
          
          ${issuesDetail}
          
          ### âœ… Recommendations
          ${review.recommendations && review.recommendations.length > 0 
            ? review.recommendations.map(rec => `- ${rec}`).join('\n') 
            : '- No specific recommendations at this time.'}
          
          ${statsInfo}
          
          ---
          <sub>ğŸ¤– Automated review by Claude Code | ğŸ”§ [Review Configuration](.github/scripts/review-config.json) | ğŸ“ [Review Template](.github/templates/review-prompt.md)</sub>`;
          
          // å‘å¸ƒè¯„è®º
          await github.rest.issues.createComment({
            issue_number: context.issue.number,
            owner: context.repo.owner,
            repo: context.repo.repo,
            body: comment
          });
          
          // å¦‚æœå®¡æŸ¥å¤±è´¥ï¼Œæ·»åŠ æ ‡ç­¾
          if (!review.approved) {
            try {
              await github.rest.issues.addLabels({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                labels: ['needs-changes', 'claude-review-failed']
              });
            } catch (error) {
              console.log('Failed to add labels:', error.message);
            }
          }
          
    - name: Update PR Status Check
      if: always() && steps.review.outputs.review_status != ''
      uses: actions/github-script@v7
      with:
        script: |
          const score = parseInt('${{ steps.review.outputs.score }}') || 0;
          const approved = '${{ steps.review.outputs.approved }}' === 'true';
          const totalIssues = parseInt('${{ steps.review.outputs.total_issues }}') || 0;
          
          // ç¡®å®šæ£€æŸ¥çŠ¶æ€
          let conclusion = 'neutral';
          let title = 'Code Review';
          let summary = '';
          
          if (approved && score >= 8) {
            conclusion = 'success';
            title = `Code Review Passed (Score: ${score}/10)`;
            summary = `âœ… Code review passed with a score of ${score}/10. No blocking issues found.`;
          } else if (score >= 6) {
            conclusion = 'neutral';
            title = `Code Review Needs Attention (Score: ${score}/10)`;
            summary = `âš ï¸ Code review completed with a score of ${score}/10. Found ${totalIssues} issues that should be addressed.`;
          } else {
            conclusion = 'failure';
            title = `Code Review Failed (Score: ${score}/10)`;
            summary = `âŒ Code review failed with a score of ${score}/10. Found ${totalIssues} issues that must be fixed.`;
          }
          
          // åˆ›å»ºæˆ–æ›´æ–°æ£€æŸ¥è¿è¡Œ
          const { data: checks } = await github.rest.checks.listForRef({
            owner: context.repo.owner,
            repo: context.repo.repo,
            ref: context.sha,
            check_name: 'Claude Code Review'
          });
          
          const checkParams = {
            owner: context.repo.owner,
            repo: context.repo.repo,
            name: 'Claude Code Review',
            head_sha: context.sha,
            status: 'completed',
            conclusion: conclusion,
            output: {
              title: title,
              summary: summary,
              text: `Please see the PR comments for detailed review feedback.`
            }
          };
          
          if (checks.check_runs.length > 0) {
            await github.rest.checks.update({
              ...checkParams,
              check_run_id: checks.check_runs[0].id
            });
          } else {
            await github.rest.checks.create(checkParams);
          }
          
    - name: Check Review Status
      if: always()
      run: |
        # è¯»å–å®¡æŸ¥ç»“æœ
        if [ -f review_result.json ]; then
          SCORE=$(jq -r '.overall_score' review_result.json)
          APPROVED=$(jq -r '.approved' review_result.json)
          SECURITY_ISSUES=$(jq -r '.security_issues | length' review_result.json)
          HIGH_SEVERITY=$(jq -r '.issues | map(select(.severity == "high")) | length' review_result.json)
          
          echo "ğŸ“Š Final Review Status:"
          echo "   Score: $SCORE/10"
          echo "   Approved: $APPROVED"
          echo "   Security Issues: $SECURITY_ISSUES"
          echo "   High Severity Issues: $HIGH_SEVERITY"
          
          # æ£€æŸ¥æ˜¯å¦é€šè¿‡
          if [ "$SECURITY_ISSUES" -gt 0 ]; then
            echo "âŒ Security issues found - blocking merge"
            exit 1
          fi
          
          if [ "$HIGH_SEVERITY" -gt 0 ]; then
            echo "âŒ High severity issues found - blocking merge"
            exit 1
          fi
          
          if [ "$SCORE" -lt 8 ]; then
            echo "âŒ Code quality below threshold (8/10) - blocking merge"
            exit 1
          fi
          
          if [ "$APPROVED" != "true" ]; then
            echo "âŒ Review not approved - blocking merge"
            exit 1
          fi
          
          echo "âœ… Code review passed - merge allowed"
        else
          echo "âŒ No review result found"
          exit 1
        fi
        
    - name: Upload Review Artifacts
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: claude-review-results
        path: |
          review_result.json
          changed_files.txt
        retention-days: 30